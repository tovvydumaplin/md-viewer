<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MD Viewer</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked + DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

  <style>
    :root{
            .icon-btn {
              padding: 8px;
              border: 1.5px solid transparent;
              background: none;
              border-radius: 8px;
              color: var(--text);
              outline: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: background 0.18s cubic-bezier(.4,0,.2,1), border 0.18s cubic-bezier(.4,0,.2,1), box-shadow 0.18s cubic-bezier(.4,0,.2,1);
              box-shadow: 0 1px 4px 0 rgba(0,0,0,0);
            }
            .icon-btn:hover {
              background: var(--panel);
              border: 1.5px solid var(--border);
              box-shadow: 0 2px 8px 0 rgba(0,0,0,.10);
            }
            [data-theme="light"] .icon-btn:hover {
              background: var(--sidebar);
            }
            #previewActions {
              transition: opacity 0.18s cubic-bezier(.4,0,.2,1), visibility 0.18s cubic-bezier(.4,0,.2,1);
              opacity: 0;
              visibility: hidden;
            }
            #previewContainer:hover #previewActions {
              opacity: 1;
              visibility: visible;
            }
            #previewActions:not(.hidden) {
              opacity: 1;
              visibility: visible;
            }
            @media print {
              #previewActions { display: none !important; }
            }
      --bg:#0b1220;
      --panel:#0f172a;
      --sidebar:#020617;
      --border:rgba(255,255,255,.08);
      --text:#e5e7eb;

      --scroll-track: rgba(255,255,255,.06);
      --scroll-thumb: rgba(255,255,255,.28);
    }

    [data-theme="light"]{
      --bg:#f8fafc;
      --panel:#ffffff;
      --sidebar:#f1f5f9;
      --border:rgba(0,0,0,.10);
      --text:#1e293b;

      --scroll-track: rgba(0,0,0,.06);
      --scroll-thumb: rgba(0,0,0,.28);
    }

    html, body { height: 100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }

    /* Markdown typography (same as your original) */
    #preview h1{font-size:26px;font-weight:700;margin:14px 0 8px}
    #preview h2{font-size:20px;font-weight:700;margin:14px 0 8px}
    #preview h3{font-size:15px;font-weight:600;margin:12px 0 6px}
    #preview h4{font-size:14px;font-weight:600;margin:12px 0 6px}
    #preview h5{font-size:13px;font-weight:600;margin:12px 0 6px}
    #preview h6{font-size:12px;font-weight:600;margin:12px 0 6px}
    #preview p{
      font-size:14px;
      line-height:1.7;
      margin:10px 0;
      color:#d1d5db;
    }
    [data-theme="light"] #preview p{ color:#475569; }
    
    #preview ul, #preview ol{
      font-size:14px;
      line-height:1.7;
      margin:10px 0;
      padding-left:24px;
      color:#d1d5db;
    }
    [data-theme="light"] #preview ul,
    [data-theme="light"] #preview ol{ color:#475569; }
    
    #preview ul{ list-style-type: disc; }
    #preview ol{ list-style-type: decimal; }
    
    #preview li{
      margin:4px 0;
      color:#d1d5db;
    }
    [data-theme="light"] #preview li{ color:#475569; }
    
    #preview a{ color:#93c5fd; }
    [data-theme="light"] #preview a{ color:#3b82f6; }

    #preview code{
      background:rgba(255,255,255,.08);
      padding:2px 6px;
      border-radius:8px;
    }
    [data-theme="light"] #preview code{ background:rgba(0,0,0,.06); }

    #preview pre{
      background:rgba(0,0,0,.25);
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      overflow:auto;
    }
    [data-theme="light"] #preview pre{ background:rgba(0,0,0,.04); }
    #preview pre code{ background:transparent;padding:0; }

    #preview blockquote{
      border-left:4px solid rgba(255,255,255,.14);
      padding:6px 12px;
      margin:10px 0;
      color:#cbd5e1;
      background:rgba(255,255,255,.03);
      border-radius:10px;
    }
    [data-theme="light"] #preview blockquote{
      border-left:4px solid rgba(0,0,0,.14);
      color:#64748b;
      background:rgba(0,0,0,.02);
    }

    .highlightJump{
      outline: 2px solid rgba(147,197,253,.45);
      outline-offset: 4px;
      border-radius: 10px;
      scroll-margin-top: 20px;
    }

    /* Mobile font sizes */
    @media (max-width: 899px) {
      #preview h1{font-size:22px;}
      #preview h2{font-size:18px;}
      #preview h3{font-size:14px;}
      #preview h4{font-size:13px;}
      #preview h5{font-size:12px;}
      #preview h6{font-size:11px;}
      #preview p{font-size:13px;}
      #preview ul, #preview ol{font-size:13px;}
    }
    [data-theme="light"] .highlightJump{
      outline: 2px solid rgba(59,130,246,.45);
    }

    /* Scrollbars */
    textarea, #preview, #preview pre, #mdCardsContainer, .content {
      scrollbar-width: thin;
      scrollbar-color: var(--scroll-thumb) var(--scroll-track);
    }
    textarea::-webkit-scrollbar,
    #preview::-webkit-scrollbar,
    #preview pre::-webkit-scrollbar,
    #mdCardsContainer::-webkit-scrollbar,
    .content::-webkit-scrollbar{
      width: 10px;
      height: 10px;
      background: transparent;
    }
    textarea::-webkit-scrollbar-track,
    #preview::-webkit-scrollbar-track,
    #preview pre::-webkit-scrollbar-track,
    #mdCardsContainer::-webkit-scrollbar-track,
    .content::-webkit-scrollbar-track{
      background: var(--scroll-track);
      border-radius: 999px;
      margin: 4px 0;
    }
    textarea::-webkit-scrollbar-thumb,
    #preview::-webkit-scrollbar-thumb,
    #preview pre::-webkit-scrollbar-thumb,
    #mdCardsContainer::-webkit-scrollbar-thumb,
    .content::-webkit-scrollbar-thumb{
      background: var(--scroll-thumb);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    textarea::-webkit-scrollbar-thumb:hover,
    #preview::-webkit-scrollbar-thumb:hover,
    #preview pre::-webkit-scrollbar-thumb:hover,
    #mdCardsContainer::-webkit-scrollbar-thumb:hover,
    .content::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.40);
      background-clip: padding-box;
    }
    [data-theme="light"] textarea::-webkit-scrollbar-thumb:hover,
    [data-theme="light"] #preview::-webkit-scrollbar-thumb:hover,
    [data-theme="light"] #preview pre::-webkit-scrollbar-thumb:hover,
    [data-theme="light"] #mdCardsContainer::-webkit-scrollbar-thumb:hover,
    [data-theme="light"] .content::-webkit-scrollbar-thumb:hover{
      background: rgba(0,0,0,.40);
      background-clip: padding-box;
    }

    /* Toast */
    #toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(0);
    }
    .loadingSpinner{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      border-top-color: #93c5fd;
      animation: spin .75s linear infinite;
      flex: 0 0 auto;
    }
    [data-theme="light"] .loadingSpinner{
      border-color: rgba(0,0,0,.16);
      border-top-color: #3b82f6;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* âœ… Print fix: print ONLY preview; force white page; remove overflow/grid constraints */
    @media print {
      html, body{
        height:auto !important;
        overflow: visible !important;
        background:#fff !important;
        color:#000 !important;
      }

      header, footer, .editorCol, #toc, #toast{
        display:none !important;
      }

      .app, .content, .wrap{
        display:block !important;
        height:auto !important;
        overflow: visible !important;
        padding:0 !important;
      }

      #preview{
        border:none !important;
        background:#fff !important;
        color:#000 !important;
        padding:20px !important;
        height:auto !important;
        min-height:auto !important;
        overflow: visible !important;
      }

      #preview p{ color:#000 !important; }
      #preview a{ color:#000 !important; text-decoration: underline !important; }
      #preview pre{ background:#f5f5f5 !important; border:1px solid #ddd !important; }
      #preview blockquote{ background:#f7f7f7 !important; color:#000 !important; border-left-color:#999 !important; }
      
      /* Prevent tables, code blocks, and blockquotes from breaking across pages */
      #preview table,
      #preview pre,
      #preview blockquote,
      #preview ul,
      #preview ol {
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      /* Keep headings with their following content */
      #preview h1,
      #preview h2,
      #preview h3,
      #preview h4,
      #preview h5,
      #preview h6 {
        page-break-after: avoid !important;
        break-after: avoid !important;
        page-break-inside: avoid !important;
        break-inside: avoid !important;
      }
      
      /* Improve text flow */
      #preview p,
      #preview li {
        orphans: 3;
        widows: 3;
      }
    }
  </style>
</head>

<body class="h-full">
  <div class="app h-screen flex flex-col">
    <!-- Header -->
    <header class="shrink-0 border-b" style="border-color: var(--border); background: var(--bg);">
      <div class="px-3 py-3 flex items-center gap-2">
        <div class="min-w-0">
          <div class="text-sm font-semibold">Markdown Viewer</div>
          <div class="text-xs opacity-80">Preview scrolls Â· header/footer stay</div>
        </div>

        <div class="flex-1"></div>

        <button id="themeToggle" type="button" title="Toggle theme"
          class="w-9 h-9 rounded-full border text-xs flex items-center justify-center active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >ðŸŒ™</button>

        <button id="hamburgerMenu" type="button" title="Menu"
          class="w-9 h-9 rounded-full border text-lg flex items-center justify-center active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >â˜°</button>

        <button id="printPdf" type="button" class="hidden"
          class="rounded-lg border px-3 py-2 text-xs active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Print to PDF</button>
        
        <button id="copyPlainText" type="button" class="hidden"
          class="rounded-lg border px-3 py-2 text-xs active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy Plain Text</button>

        <button id="copyHtml" type="button" class="hidden"
          class="rounded-lg border px-3 py-2 text-xs active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy HTML</button>

        <button id="copyMd" type="button" class="hidden"
          class="rounded-lg border px-3 py-2 text-xs active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy MD</button>

        <button id="clear" type="button" class="hidden"
          class="rounded-lg border px-3 py-2 text-xs active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Clear</button>
      </div>
    </header>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="hidden fixed inset-0 bg-black/50 z-40"></div>

    <!-- Mobile Navigation Drawer -->
    <div id="mobileNav" class="fixed top-0 right-0 bottom-0 w-72 z-50 p-6 transform translate-x-full transition-transform duration-300 border-l overflow-y-auto"
         style="background: var(--panel); border-color: var(--border);">
      <button id="closeMenu" type="button" class="absolute top-4 right-4 text-2xl" style="color: var(--text);">Ã—</button>
      <div class="mt-12 flex flex-col gap-3">
        <button id="printPdfMobile" type="button"
          class="rounded-lg border px-3 py-2 text-xs w-full active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Print to PDF</button>
        <button id="copyPlainTextMobile" type="button"
          class="rounded-lg border px-3 py-2 text-xs w-full active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy Plain Text</button>
        <button id="copyHtmlMobile" type="button"
          class="rounded-lg border px-3 py-2 text-xs w-full active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy HTML</button>
        <button id="copyMdMobile" type="button"
          class="rounded-lg border px-3 py-2 text-xs w-full active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Copy MD</button>
        <button id="clearMobile" type="button"
          class="rounded-lg border px-3 py-2 text-xs w-full active:translate-y-px transition"
          style="border-color: var(--border); background: rgba(255,255,255,.06); color: var(--text);"
        >Clear</button>

        <!-- TOC Section in Mobile Menu -->
        <div class="mt-6 pt-6 border-t" style="border-color: var(--border);">
          <div class="text-xs opacity-85 mb-3" style="color: var(--text);">Table of Contents</div>
          <div id="tocListMobile" class="flex flex-col gap-2"></div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content flex-1 min-h-0 max-[900px]:overflow-auto md:overflow-hidden">
      <!-- âœ… Responsive: stack on mobile, 2 columns on md+ -->
      <div class="wrap md:h-full grid gap-3 p-3 box-border grid-cols-1 md:grid-cols-[280px_1fr] md:gap-3">
        <!-- Left column -->
        <div class="editorCol md:h-full flex flex-col gap-3 min-h-0">
          <!-- Cards (desktop: 70% height) (mobile: fixed-ish height) -->
          <div class="min-h-0 overflow-hidden border md:h-[58vh] flex flex-col"
               style="border-color: var(--border); background: var(--sidebar);">
            <div class="p-2 pb-1 border-b" style="border-color: var(--border);">
              <div class="flex items-center gap-2">
                <input
                  id="mdCardsSearch"
                  type="search"
                  placeholder="Search files... (Ctrl/Cmd+K)"
                  class="w-full rounded-md border px-2 py-1.5 text-xs outline-none"
                  style="border-color: var(--border); background: var(--panel); color: var(--text);"
                />
              </div>
              <div id="mdCardsSearchCount" class="text-[10px] mt-1 opacity-65">0 files</div>
            </div>
            <div id="mdCardsContainer" class="h-[38vh] md:h-full overflow-y-auto overflow-x-hidden p-2 box-border"></div>
          </div>

          <!-- Textarea -->
          <div class="min-h-0 flex flex-col md:flex-[3_1_0]">
            <textarea id="md" placeholder="Paste markdown here..."
              class="w-full min-h-0 resize-none border p-3 outline-none text-xs leading-relaxed md:h-full transition-all duration-300"
              style="border-color: var(--border); background: var(--sidebar); color: var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
            ># ðŸ‘‹ Welcome

Welcome to this project!  
This repository contains the core codebase for the system and serves as the foundation for ongoing development, improvements, and future features.

Whether youâ€™re here to explore, contribute, or maintain the project â€” youâ€™re in the right place.
            </textarea>
          </div>
        </div>

        <!-- Right column (sticky on mobile) -->
        <div class="md:h-full flex flex-col gap-3 min-h-0 flex-1 max-[900px]:sticky max-[900px]:top-0 max-[900px]:z-10">
          <!-- TOC Pills (Desktop only) -->
          <div id="toc"
               class="shrink-0 border p-3 flex items-center gap-3 max-[900px]:hidden"
               style="border-color: var(--border); background: rgba(2,6,23,.55);">
            <div class="min-w-0 shrink-0">
              <div class="text-xs opacity-85">Sections</div>
              <div class="text-[11px] opacity-65">Click a pill to jump</div>
            </div>
            <div id="tocList" class="flex gap-2 flex-wrap" style="scrollbar-width: thin; scrollbar-color: var(--scroll-thumb) var(--scroll-track);"></div>
          </div>
          <div id="readingProgressTrack" class="shrink-0 h-1 rounded-full overflow-hidden border"
               style="border-color: var(--border); background: rgba(255,255,255,.08);">
            <div id="readingProgressBar" class="h-full transition-all duration-150" style="width: 0%; background: #60a5fa;"></div>
          </div>

          <!-- Preview -->
          <div id="previewContainer" class="relative flex-1 min-h-0 h-full">
            <div id="preview"
                 class="h-full flex-1 min-h-0 overflow-y-auto overflow-x-hidden border p-6 max-[900px]:max-h-[70vh]"
                 style="border-color: var(--border); background: var(--panel);"></div>
            <div id="previewLoading"
                 class="hidden absolute inset-0 z-10 items-center justify-center pointer-events-none"
                 style="background: rgba(2,6,23,.18);">
              <div class="flex items-center gap-2 px-3 py-2 rounded-full border text-xs"
                   style="border-color: var(--border); background: var(--panel); color: var(--text);">
                <span class="loadingSpinner" aria-hidden="true"></span>
                <span>Loading markdown...</span>
              </div>
            </div>
            <!-- Floating buttons -->
            <div id="previewActions" class="hidden absolute top-3 right-3 flex gap-2 z-20">
              <button id="downloadBtn" title="Download as PDF" class="icon-btn">
                <!-- Download icon: Arrow into tray -->
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v10m0 0l-4-4m4 4l4-4" stroke-linecap="round" stroke-linejoin="round"/><rect x="4" y="18" width="16" height="2" rx="1"/></svg>
              </button>
              <button id="maximizeBtn" title="Maximize preview" class="icon-btn">
                <!-- Maximize: Four corners -->
                <svg id="maximizeIcon" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="4 8 4 4 8 4"/><polyline points="20 8 20 4 16 4"/><polyline points="4 16 4 20 8 20"/><polyline points="20 16 20 20 16 20"/></svg>
                <!-- Minimize: Rectangle with inward arrows -->
                <svg id="minimizeIcon" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="display:none"><line x1="6" y1="12" x2="18" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              </button>
            </div>
          </div>
            <style>
              .icon-btn {
                padding: 8px;
                border: 1.5px solid transparent;
                background: none;
                border-radius: 8px;
                color: var(--text);
                transition: background 0.15s, border 0.15s;
                outline: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .icon-btn:hover {
                background: var(--panel);
                border: 1.5px solid var(--border);
              }
              [data-theme="light"] .icon-btn:hover {
                background: var(--sidebar);
              }
            </style>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="shrink-0 h-12 flex items-center justify-center gap-2 border-t text-xs"
            style="border-color: var(--border); background: var(--bg); color: rgba(229,231,235,.75);">
      <span>Â©</span>
      <span id="year"></span>
      <span>Tovvy B. Dumaplin. All rights reserved.</span>
    </footer>
  </div>

  <!-- Toast -->
  <div id="toast"
       class="fixed left-1/2 bottom-16 -translate-x-1/2 translate-y-5 opacity-0 pointer-events-none z-[60]
              border px-4 py-2 rounded-full text-sm max-w-[calc(100vw-24px)] whitespace-nowrap overflow-hidden text-ellipsis transition-all duration-150"
       style="border-color: var(--border); background: rgba(2,6,23,.92); color: #e5e7eb;"
       role="status" aria-live="polite"></div>

  <script>
    marked.setOptions({ gfm:true, breaks:true });

    const md = document.getElementById("md");
    const preview = document.getElementById("preview");
    const previewLoading = document.getElementById("previewLoading");
    const previewContainer = document.getElementById("previewContainer");
    const previewActions = document.getElementById("previewActions");
    const downloadBtn = document.getElementById("downloadBtn");
    const maximizeBtn = document.getElementById("maximizeBtn");
    const maximizeIcon = document.getElementById("maximizeIcon");
    const minimizeIcon = document.getElementById("minimizeIcon");
        // --- Preview hover actions ---
        let isMaximized = false;
        function showPreviewActions() {
          if (!isMaximized) previewActions.classList.remove("hidden");
        }
        function hidePreviewActions() {
          if (!isMaximized) previewActions.classList.add("hidden");
        }
        previewContainer.addEventListener("mouseenter", showPreviewActions);
        previewContainer.addEventListener("mouseleave", hidePreviewActions);

        // --- Download to PDF ---
        downloadBtn.addEventListener("click", () => {
          // Hide actions before print
          previewActions.style.display = "none";
          setTimeout(() => {
            printPdf.click();
            setTimeout(() => { previewActions.style.display = ""; }, 500);
          }, 50);
        });

        // --- Maximize/minimize preview ---
        maximizeBtn.addEventListener("click", () => {
          isMaximized = !isMaximized;
          if (isMaximized) {
            document.querySelector(".editorCol").style.display = "none";
            document.querySelector("footer").style.display = "none";
            document.querySelector("header").style.display = "none";
            document.querySelector(".content .wrap > .md\\:h-full").style.display = "none";
            previewContainer.classList.add("z-50");
            previewContainer.style.position = "fixed";
            previewContainer.style.inset = "0";
            previewContainer.style.background = "var(--panel)";
            previewContainer.style.borderRadius = "0";
            previewContainer.style.boxShadow = "0 0 0 9999px rgba(0,0,0,.5)";
            previewActions.classList.remove("hidden");
            maximizeIcon.style.display = "none";
            minimizeIcon.style.display = "inline";
            document.getElementById("toc").style.display = "flex";
            // Restore scrollability
            preview.classList.add("min-h-0", "overflow-y-auto", "overflow-x-hidden");
            preview.style.maxHeight = "100vh";
            maximizeBtn.title = "Minimize preview";
          } else {
            document.querySelector(".editorCol").style.display = "";
            document.querySelector("footer").style.display = "";
            document.querySelector("header").style.display = "";
            document.querySelector(".content .wrap > .md\\:h-full").style.display = "";
            previewContainer.classList.remove("z-50");
            previewContainer.style.position = "";
            previewContainer.style.inset = "";
            previewContainer.style.background = "";
            previewContainer.style.borderRadius = "";
            previewContainer.style.boxShadow = "";
            previewActions.classList.add("hidden");
            maximizeIcon.style.display = "inline";
            minimizeIcon.style.display = "none";
            document.getElementById("toc").style.display = "";
            // Restore scrollability to default
            preview.classList.add("min-h-0", "overflow-y-auto", "overflow-x-hidden");
            preview.style.maxHeight = "";
            maximizeBtn.title = "Maximize preview";
          }
        });
    const toast = document.getElementById("toast");
    const mdCardsContainer = document.getElementById("mdCardsContainer");
    const mdCardsSearch = document.getElementById("mdCardsSearch");
    const mdCardsSearchCount = document.getElementById("mdCardsSearchCount");
    const readingProgressTrack = document.getElementById("readingProgressTrack");
    const readingProgressBar = document.getElementById("readingProgressBar");

    let mdFiles = [];
    let mdSearchTerm = "";
    let activeFilePath = "";
    let isIndexingCards = false;
    let cardRenderQueued = false;
    const collapsedFoldersStorageKey = "mdViewerCollapsedFolders";
    let collapsedFolders = {};

    try {
      collapsedFolders = JSON.parse(localStorage.getItem(collapsedFoldersStorageKey) || "{}");
      if (!collapsedFolders || typeof collapsedFolders !== "object") collapsedFolders = {};
    } catch {
      collapsedFolders = {};
    }

    function saveCollapsedFolders() {
      try {
        localStorage.setItem(collapsedFoldersStorageKey, JSON.stringify(collapsedFolders));
      } catch {}
    }

    function setPreviewLoading(isLoading) {
      if (isLoading) {
        previewLoading.classList.remove("hidden");
        previewLoading.classList.add("flex");
      } else {
        previewLoading.classList.add("hidden");
        previewLoading.classList.remove("flex");
      }
    }

    function updateReadingProgress() {
      if (!readingProgressBar) return;
      const hasContent = preview.textContent.trim().length > 0;
      if (!hasContent) {
        readingProgressBar.style.width = "0%";
        return;
      }

      const maxScroll = preview.scrollHeight - preview.clientHeight;
      if (maxScroll <= 0) {
        readingProgressBar.style.width = "100%";
        return;
      }

      const ratio = Math.min(1, Math.max(0, preview.scrollTop / maxScroll));
      readingProgressBar.style.width = `${(ratio * 100).toFixed(1)}%`;
    }

    function queueCardRender() {
      if (cardRenderQueued) return;
      cardRenderQueued = true;
      requestAnimationFrame(() => {
        cardRenderQueued = false;
        renderMarkdownCards();
      });
    }

    async function hydrateMarkdownMeta(file) {
      try {
        const res = await fetch(file.path);
        if (!res.ok) throw new Error(`Failed to fetch ${file.path}`);
        const text = await res.text();
        const lines = text.split(/\r?\n/);
        file.title = lines.find(l => l.trim().startsWith('#'))?.replace(/^#+\s*/, '') || file.name;

        const contentLines = lines.filter(l => l.trim() && !l.trim().startsWith('#') && !l.trim().startsWith('---'));
        let previewParts = [];

        for (const line of contentLines.slice(0, 3)) {
          const cleaned = line
            .replace(/\*\*([^*]+)\*\*/g, '$1')
            .replace(/\*([^*]+)\*/g, '$1')
            .replace(/__([^_]+)__/g, '$1')
            .replace(/_([^_]+)_/g, '$1')
            .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
            .replace(/`([^`]+)`/g, '$1')
            .trim();

          if (cleaned) previewParts.push(cleaned);
          if (previewParts.length >= 2) break;
        }

        file.preview = previewParts.join(' - ').substring(0, 100);
      } catch {
        file.title = file.name;
        file.preview = 'Preview unavailable';
      } finally {
        file.isLoadingMeta = false;
      }
    }

    async function loadMarkdownFiles() {
      mdFiles = [];
      isIndexingCards = true;
      renderMarkdownCards();
      let filePaths = [];

      try {
        const res = await fetch('Markdown/files.json');
        if (res.ok) {
          const data = await res.json();
          filePaths = data.files.map(f => f.path);
        }
      } catch (e) {
        filePaths = [
          'Markdown/Developer/CODING-STANDARDS.md',
          'Markdown/Developer/TECH-STACK-PLAN.md',
          'Markdown/Management/PROGRESS-REPORT-2026-01-30.md',
          'Markdown/Management/PROJECT-OVERVIEW-FOR-MANAGEMENT.md',
          'Markdown/Management/Server-hosting.md'
        ];
      }

      mdFiles = filePaths.map((path) => {
        const parts = path.split('/');
        const filename = parts[parts.length - 1];
        const folder = parts[parts.length - 2];
        return {
          name: filename,
          path,
          folder,
          title: filename,
          preview: 'Loading preview...',
          isLoadingMeta: true
        };
      });

      renderMarkdownCards();

      for (const file of mdFiles) {
        await hydrateMarkdownMeta(file);
        queueCardRender();
      }

      isIndexingCards = false;
      renderMarkdownCards();
    }

    function setFolderHeaderLabel(folderHeader, folderName, fileCount, isCollapsed) {
      folderHeader.textContent = `${isCollapsed ? "[+]" : "[-]"} ${folderName} (${fileCount})`;
    }

    function setFolderBodyState(folderBody, isCollapsed, shouldAnimate) {
      folderBody.dataset.collapsed = isCollapsed ? "true" : "false";
      folderBody.style.overflow = "hidden";
      folderBody.style.transition = shouldAnimate
        ? "max-height 220ms cubic-bezier(.4,0,.2,1), opacity 180ms ease"
        : "none";

      if (isCollapsed) {
        if (!shouldAnimate) {
          folderBody.style.maxHeight = "0px";
          folderBody.style.opacity = "0";
          folderBody.style.pointerEvents = "none";
          return;
        }
        const currentHeight = folderBody.scrollHeight;
        folderBody.style.maxHeight = `${currentHeight}px`;
        folderBody.style.opacity = "1";
        folderBody.style.pointerEvents = "auto";
        requestAnimationFrame(() => {
          folderBody.style.maxHeight = "0px";
          folderBody.style.opacity = "0";
          folderBody.style.pointerEvents = "none";
        });
        return;
      }

      folderBody.style.pointerEvents = "auto";
      if (!shouldAnimate) {
        folderBody.style.maxHeight = "none";
        folderBody.style.opacity = "1";
        return;
      }

      folderBody.style.maxHeight = "0px";
      folderBody.style.opacity = "0";
      requestAnimationFrame(() => {
        const targetHeight = folderBody.scrollHeight;
        folderBody.style.maxHeight = `${targetHeight}px`;
        folderBody.style.opacity = "1";
      });
      const onTransitionEnd = (event) => {
        if (event.propertyName !== "max-height") return;
        folderBody.style.maxHeight = "none";
        folderBody.removeEventListener("transitionend", onTransitionEnd);
      };
      folderBody.addEventListener("transitionend", onTransitionEnd);
    }

    function updateCollapsedHintState() {
      const existingHint = mdCardsContainer.querySelector('[data-role="collapsed-hint"]');
      const query = mdSearchTerm.trim();
      if (query) {
        if (existingHint) existingHint.remove();
        return;
      }

      const folderBodies = Array.from(mdCardsContainer.querySelectorAll('[data-folder-body="true"]'));
      const hasFolders = folderBodies.length > 0;
      const allCollapsed = hasFolders && folderBodies.every((el) => el.dataset.collapsed === "true");

      if (allCollapsed) {
        if (!existingHint) {
          const allCollapsedHint = document.createElement('div');
          allCollapsedHint.className = "text-xs opacity-65 p-3";
          allCollapsedHint.textContent = "All folders are collapsed. Click [+] to expand.";
          allCollapsedHint.dataset.role = "collapsed-hint";
          mdCardsContainer.appendChild(allCollapsedHint);
        }
        return;
      }

      if (existingHint) existingHint.remove();
    }

    function setCardVisualState(card, isActive, isHover) {
      if (isActive) {
        card.style.background = isHover ? "rgba(59,130,246,.22)" : "rgba(59,130,246,.14)";
        card.style.boxShadow = "inset 3px 0 0 #3b82f6";
        card.style.transform = isHover ? "translateX(4px)" : "translateX(0)";
        return;
      }
      card.style.background = isHover ? "rgba(147,197,253,.08)" : "transparent";
      card.style.boxShadow = "none";
      card.style.transform = isHover ? "translateX(4px)" : "translateX(0)";
    }

    function renderMarkdownCards() {
      mdCardsContainer.innerHTML = '';
      const query = mdSearchTerm.trim().toLowerCase();
      const filteredFiles = query
        ? mdFiles.filter((file) => {
            const haystack = `${file.title} ${file.name} ${file.folder} ${file.preview}`.toLowerCase();
            return haystack.includes(query);
          })
        : mdFiles;

      const loadedCount = mdFiles.filter(file => !file.isLoadingMeta).length;
      if (query) {
        mdCardsSearchCount.textContent = isIndexingCards
          ? `${filteredFiles.length} of ${mdFiles.length} files - indexed ${loadedCount}/${mdFiles.length}`
          : `${filteredFiles.length} of ${mdFiles.length} files`;
      } else {
        mdCardsSearchCount.textContent = isIndexingCards
          ? `${mdFiles.length} files - indexed ${loadedCount}/${mdFiles.length}`
          : `${mdFiles.length} files`;
      }

      if (!filteredFiles.length) {
        if (isIndexingCards && !mdFiles.length) {
          const loading = document.createElement('div');
          loading.className = "text-xs opacity-70 p-3 flex items-center gap-2";
          loading.innerHTML = '<span class="loadingSpinner" aria-hidden="true"></span><span>Loading files...</span>';
          mdCardsContainer.appendChild(loading);
          return;
        }
        const empty = document.createElement('div');
        empty.className = "text-xs opacity-65 p-3";
        empty.textContent = `No files match "${mdSearchTerm.trim()}".`;
        mdCardsContainer.appendChild(empty);
        return;
      }

      const grouped = {};
      filteredFiles.forEach(file => {
        if (!grouped[file.folder]) grouped[file.folder] = [];
        grouped[file.folder].push(file);
      });

      Object.keys(grouped).sort().forEach(folder => {
        const canCollapse = !query;
        const isCollapsed = canCollapse && !!collapsedFolders[folder];
        const fileCount = grouped[folder].length;

        const folderHeader = document.createElement('button');
        folderHeader.type = "button";
        folderHeader.className = "w-full text-left text-[11px] font-bold uppercase opacity-70 mx-1 mt-3 mb-2 tracking-wide px-2 py-1 rounded";
        folderHeader.style.color = "var(--text)";
        folderHeader.style.background = "rgba(255,255,255,.04)";
        setFolderHeaderLabel(folderHeader, folder, fileCount, isCollapsed);

        if (canCollapse) {
          folderHeader.addEventListener('click', () => {
            const nextCollapsed = !collapsedFolders[folder];
            collapsedFolders[folder] = nextCollapsed;
            saveCollapsedFolders();
            setFolderHeaderLabel(folderHeader, folder, fileCount, nextCollapsed);
            setFolderBodyState(folderBody, nextCollapsed, true);
            updateCollapsedHintState();
          });
        } else {
          folderHeader.disabled = true;
          folderHeader.style.cursor = "default";
        }

        mdCardsContainer.appendChild(folderHeader);
        const folderBody = document.createElement('div');
        folderBody.dataset.folderBody = "true";

        grouped[folder].forEach((file) => {
          const globalIdx = mdFiles.indexOf(file);

          const card = document.createElement('div');
          card.className =
            "cursor-pointer select-none border-b last:border-b-0 px-4 py-3 transition-all duration-200";
          card.style.borderColor = "var(--border)";
          const isActiveCard = file.path === activeFilePath;
          card.setAttribute("aria-current", isActiveCard ? "true" : "false");
          setCardVisualState(card, isActiveCard, false);

          card.addEventListener('mouseenter', () => {
            setCardVisualState(card, file.path === activeFilePath, true);
          });
          card.addEventListener('mouseleave', () => {
            setCardVisualState(card, file.path === activeFilePath, false);
          });

          if (file.isLoadingMeta) {
            card.innerHTML = `
              <div class="flex items-center gap-2 mb-1">
                <span class="loadingSpinner" aria-hidden="true"></span>
                <div class="text-[12px] font-semibold opacity-80">${file.name}</div>
              </div>
              <div class="text-[11px] opacity-60 leading-snug">Loading preview...</div>
            `;
          } else {
            card.innerHTML = `
              <div class="text-[13px] font-semibold mb-1">${file.title}</div>
              <div class="text-[11px] opacity-65 leading-snug">${file.preview}</div>
            `;
          }
          card.addEventListener('click', () => loadMarkdownFile(globalIdx));
          folderBody.appendChild(card);
        });

        mdCardsContainer.appendChild(folderBody);
        setFolderBodyState(folderBody, isCollapsed, false);
      });

      updateCollapsedHintState();
    }

    async function loadMarkdownFile(idx) {
      const file = mdFiles[idx];
      if (!file) return;
      activeFilePath = file.path;
      renderMarkdownCards();

      setPreviewLoading(true);
      try {
        const res = await fetch(file.path);
        if (!res.ok) throw new Error(`Failed to load ${file.path}`);
        const mdText = await res.text();
        md.value = mdText;
        render();
        preview.scrollTop = 0;
        updateReadingProgress();
        notify(`Loaded: ${file.title || file.name}`);
      } catch {
        notify('Failed to load file');
      } finally {
        setPreviewLoading(false);
      }
    }

    const copyMd = document.getElementById("copyMd");
    const copyHtml = document.getElementById("copyHtml");
    const copyPlainText = document.getElementById("copyPlainText");
    const clear = document.getElementById("clear");
    const themeToggle = document.getElementById("themeToggle");
    const printPdf = document.getElementById("printPdf");
    const tocList = document.getElementById("tocList");
    const tocListMobile = document.getElementById("tocListMobile");

    // Hamburger menu elements
    const hamburgerMenu = document.getElementById("hamburgerMenu");
    const mobileNav = document.getElementById("mobileNav");
    const mobileOverlay = document.getElementById("mobileOverlay");
    const closeMenu = document.getElementById("closeMenu");
    const printPdfMobile = document.getElementById("printPdfMobile");
    const copyPlainTextMobile = document.getElementById("copyPlainTextMobile");
    const copyHtmlMobile = document.getElementById("copyHtmlMobile");
    const copyMdMobile = document.getElementById("copyMdMobile");
    const clearMobile = document.getElementById("clearMobile");

    // Menu toggle functions
    function openMenu() {
      mobileNav.classList.remove('translate-x-full');
      mobileOverlay.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeMenuFn() {
      mobileNav.classList.add('translate-x-full');
      mobileOverlay.classList.add('hidden');
      document.body.style.overflow = '';
    }

    hamburgerMenu.addEventListener('click', openMenu);
    closeMenu.addEventListener('click', closeMenuFn);
    mobileOverlay.addEventListener('click', closeMenuFn);

    // Mobile button handlers
    printPdfMobile.addEventListener('click', () => { closeMenuFn(); printPdf.click(); });
    copyPlainTextMobile.addEventListener('click', () => { closeMenuFn(); copyPlainText.click(); });
    copyHtmlMobile.addEventListener('click', () => { closeMenuFn(); copyHtml.click(); });
    copyMdMobile.addEventListener('click', () => { closeMenuFn(); copyMd.click(); });
    clearMobile.addEventListener('click', () => { closeMenuFn(); clear.click(); });

    mdCardsSearch.addEventListener('input', () => {
      mdSearchTerm = mdCardsSearch.value;
      renderMarkdownCards();
    });

    mdCardsSearch.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        mdCardsSearch.value = '';
        mdSearchTerm = '';
        renderMarkdownCards();
        mdCardsSearch.blur();
      }
    });

    document.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 'k') {
        event.preventDefault();
        mdCardsSearch.focus();
        mdCardsSearch.select();
      }
    });

    // Textarea expand/collapse on mobile
    const textarea = document.getElementById('md');
    
    function expandTextarea() {
      const isMobile = window.innerWidth < 900;
      if (isMobile) {
        textarea.classList.remove('h-[12vh]', 'h-[28vh]');
        textarea.classList.add('h-[40vh]');
      }
    }
    
    function collapseTextarea() {
      const isMobile = window.innerWidth < 900;
      if (isMobile) {
        textarea.classList.remove('h-[40vh]', 'h-[28vh]');
        textarea.classList.add('h-[12vh]');
      }
    }
    
    function handleTextareaResize() {
      const isMobile = window.innerWidth < 900;
      if (!isMobile) {
        textarea.classList.remove('h-[12vh]', 'h-[40vh]');
        textarea.classList.add('h-[28vh]');
      } else if (document.activeElement === textarea) {
        expandTextarea();
      } else {
        collapseTextarea();
      }
    }
    
    textarea.addEventListener('focus', expandTextarea);
    textarea.addEventListener('blur', collapseTextarea);
    window.addEventListener('resize', handleTextareaResize);
    handleTextareaResize(); // Initial setup

    document.getElementById("year").textContent = new Date().getFullYear();

    let timer;

    const savedTheme = localStorage.getItem("mdViewerTheme") || "dark";
    document.documentElement.setAttribute("data-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "ðŸŒ™" : "â˜€ï¸";

    function applyThemeSurfaces() {
      const theme = document.documentElement.getAttribute("data-theme");
      const toc = document.getElementById("toc");
      if (theme === "light") {
        toc.style.background = "rgba(241,245,249,.95)";
        toast.style.background = "rgba(241,245,249,.98)";
        toast.style.color = "#1e293b";
        if (readingProgressTrack) readingProgressTrack.style.background = "rgba(15,23,42,.08)";
        if (readingProgressBar) readingProgressBar.style.background = "#2563eb";
      } else {
        toc.style.background = "rgba(2,6,23,.55)";
        toast.style.background = "rgba(2,6,23,.92)";
        toast.style.color = "#e5e7eb";
        if (readingProgressTrack) readingProgressTrack.style.background = "rgba(255,255,255,.08)";
        if (readingProgressBar) readingProgressBar.style.background = "#60a5fa";
      }
    }
    applyThemeSurfaces();

    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme");
      const newTheme = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", newTheme);
      themeToggle.textContent = newTheme === "dark" ? "ðŸŒ™" : "â˜€ï¸";
      localStorage.setItem("mdViewerTheme", newTheme);
      applyThemeSurfaces();
      notify(`${newTheme === "dark" ? "Dark" : "Light"} mode enabled`);
    });

    function notify(msg){
      toast.textContent = msg;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
      clearTimeout(timer);
      timer = setTimeout(()=>toast.classList.remove("show"),1600);
    }

    function slugify(text){
      return (text || "")
        .toLowerCase()
        .trim()
        .replace(/[\s]+/g, "-")
        .replace(/[^\w\-]+/g, "");
    }

    function scrollPreviewToHeading(h){
      h.scrollIntoView({ behavior:"smooth", block:"start" });
      h.classList.add("highlightJump");
      setTimeout(() => h.classList.remove("highlightJump"), 900);
      setTimeout(updateReadingProgress, 220);
    }

    function buildTOC(){
      tocList.innerHTML = "";
      tocListMobile.innerHTML = "";
      const headings = preview.querySelectorAll("h2");

      if (!headings.length){
        const empty = document.createElement("span");
        empty.className = "text-xs opacity-65";
        empty.textContent = "No sections found (add ## headings).";
        tocList.appendChild(empty);
        
        const emptyMobile = document.createElement("span");
        emptyMobile.className = "text-xs opacity-65";
        emptyMobile.textContent = "No sections found (add ## headings).";
        tocListMobile.appendChild(emptyMobile);
        return;
      }

      headings.forEach((h, idx) => {
        if (!h.id){
          const base = slugify(h.textContent) || `section-${idx+1}`;
          let id = base, n = 2;
          while (preview.querySelector(`#${CSS.escape(id)}`)) id = `${base}-${n++}`;
          h.id = id;
        }

        // Desktop TOC button
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "px-3 py-1.5 rounded-full text-xs border transition active:translate-y-px whitespace-nowrap";
        btn.style.borderColor = "var(--border)";
        btn.style.background = "rgba(255,255,255,.06)";
        btn.style.color = "var(--text)";
        btn.textContent = h.textContent.trim() || `Section ${idx+1}`;
        btn.addEventListener("click", () => scrollPreviewToHeading(h));
        tocList.appendChild(btn);

        // Mobile TOC button (full width)
        const btnMobile = document.createElement("button");
        btnMobile.type = "button";
        btnMobile.className = "px-3 py-2 rounded-lg text-xs border transition active:translate-y-px w-full text-left";
        btnMobile.style.borderColor = "var(--border)";
        btnMobile.style.background = "rgba(255,255,255,.06)";
        btnMobile.style.color = "var(--text)";
        btnMobile.textContent = h.textContent.trim() || `Section ${idx+1}`;
        btnMobile.addEventListener("click", () => {
          scrollPreviewToHeading(h);
          closeMenuFn();
        });
        tocListMobile.appendChild(btnMobile);
      });
    }

    function render(){
      const html = marked.parse(md.value || "");
      preview.innerHTML = DOMPurify.sanitize(html);

      const firstH1 = preview.querySelector('h1');
      document.title = firstH1 ? (firstH1.textContent.trim() || 'MD Viewer') : 'MD Viewer';

      const hasText = md.value.trim().length > 0;
      copyMd.disabled = !hasText;
      copyHtml.disabled = !hasText;
      copyPlainText.disabled = !hasText;
      clear.disabled = !hasText;
      printPdf.disabled = !hasText;

      buildTOC();
      updateReadingProgress();
    }

    async function copyText(text, label){
      const value = (text || "").trim();
      if (!value) return notify("Nothing to copy.");

      try{
        await navigator.clipboard.writeText(text);
        notify(`${label} copied âœ…`);
      }catch(e){
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.setAttribute("readonly","");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          notify(`${label} copied âœ…`);
        }catch(err){
          notify("Copy failed (browser blocked it).");
        }
      }
    }

    md.addEventListener("input", render);
    preview.addEventListener("scroll", updateReadingProgress);
    window.addEventListener("resize", updateReadingProgress);

    printPdf.addEventListener("click", () => {
      if (!md.value.trim()) return;
      window.print();
      notify("Print dialog opened ðŸ–¨ï¸");
    });

    copyPlainText.addEventListener("click", () => {
      if (!preview.textContent.trim()) return;
      const plainText = preview.innerText || preview.textContent;
      copyText(plainText, "Plain text");
    });

    copyMd.addEventListener("click", () => copyText(md.value || "", "Markdown"));
    copyHtml.addEventListener("click", () => copyText(preview.innerHTML || "", "HTML"));

    clear.addEventListener("click", () => {
      if (!md.value.trim()) return;
      md.value = "";
      render();
      notify("Cleared âœ…");
      md.focus();
    });

    render();
    loadMarkdownFiles();
  </script>
</body>
</html>
